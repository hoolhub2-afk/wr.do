# WR.DO 部署指南

WR.DO 是一站式域名服务平台，集成短链服务、临时邮箱、子域名管理、文件存储和开放 API 接口。

- **技术栈**: Next.js 14 + React 18 + TypeScript + Prisma + PostgreSQL
- **包管理器**: pnpm
- **数据库**: PostgreSQL

## 目录

1. [环境要求](#1-环境要求)
2. [准备配置文件](#2-准备配置文件)
3. [部署方式](#3-部署方式)
   - [方式一：Vercel 部署](#31-vercel-部署)
   - [方式二：Docker Compose 部署](#32-docker-compose-部署)
   - [方式三：手动服务器部署](#33-手动服务器部署)
4. [本地开发](#4-本地开发)
5. [环境变量说明](#5-环境变量说明)
6. [常见问题](#6-常见问题)

---

## 1. 环境要求

### 通用要求

- **Node.js**: v20.x 或更高版本
- **pnpm**: 建议使用 Corepack 启用 `corepack enable`
- **PostgreSQL**: 9.4.0 或更高版本

### Docker 部署要求

- **Docker Engine**: 20.x 或更高版本
- **Docker Compose**: V2.x

---

## 2. 准备配置文件

### 2.1 克隆项目

```bash
git clone https://github.com/oiov/wr.do
cd wr.do
```

### 2.2 创建环境变量文件

```bash
cp .env.example .env
```

### 2.3 配置必要环境变量

编辑 `.env` 文件，至少填写以下核心变量：

```env
# 数据库连接（必须）
DATABASE_URL='postgres://user:password@host:5432/dbname'

# 认证密钥（必须，建议使用随机字符串）
AUTH_SECRET=your-super-secret-key-at-least-32-chars

# 应用地址（必须）
NEXT_PUBLIC_APP_URL=http://localhost:3000
AUTH_URL=http://localhost:3000
```

---

## 3. 部署方式

### 3.1 Vercel 部署

#### 步骤 1：连接仓库

1. 访问 [Vercel](https://vercel.com/new/clone?repository-url=https://github.com/oiov/wr.do.git&project-name=wrdo)
2. 点击 **Deploy** 按钮

#### 步骤 2：配置环境变量

在 Vercel 控制台的 **Settings → Environment Variables** 中添加以下变量：

| 变量名 | 必填 | 说明 |
|--------|------|------|
| `DATABASE_URL` | 是 | PostgreSQL 连接字符串 |
| `AUTH_SECRET` | 是 | 至少 32 字符的随机字符串 |
| `NEXT_PUBLIC_APP_URL` | 是 | 部署后的应用地址 |
| `AUTH_URL` | 是 | 同上 |

#### 步骤 3：部署

Vercel 会自动构建并部署。访问生成的 URL 进行验证。

---

### 3.2 Docker Compose 部署

#### 方案 A：使用外部数据库

创建 `docker-compose.yml`：

```yaml
services:
  app:
    image: ghcr.io/oiov/wr.do/wrdo:${TAG:-main}
    container_name: wrdo
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL}
      AUTH_SECRET: ${AUTH_SECRET:-your-auth-secret}
      AUTH_URL: ${AUTH_URL}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GITHUB_ID: ${GITHUB_ID}
      GITHUB_SECRET: ${GITHUB_SECRET}
      LinuxDo_CLIENT_ID: ${LinuxDo_CLIENT_ID}
      LinuxDo_CLIENT_SECRET: ${LinuxDo_CLIENT_SECRET}
      RESEND_API_KEY: ${RESEND_API_KEY}
      BREVO_API_KEY: ${BREVO_API_KEY}
      EMAIL_FROM: ${EMAIL_FROM}
      EMAIL_FROM_NAME: ${EMAIL_FROM_NAME}
      NEXT_PUBLIC_EMAIL_R2_DOMAIN: ${NEXT_PUBLIC_EMAIL_R2_DOMAIN}
      NEXT_PUBLIC_GOOGLE_ID: ${NEXT_PUBLIC_GOOGLE_ID}
      SCREENSHOTONE_BASE_URL: ${SCREENSHOTONE_BASE_URL}
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      SKIP_DB_CHECK: ${SKIP_DB_CHECK}
      SKIP_DB_MIGRATION: ${SKIP_DB_MIGRATION}
    restart: unless-stopped
```

#### 方案 B：包含本地 PostgreSQL

创建 `docker-compose.yml`：

```yaml
services:
  app:
    image: ghcr.io/oiov/wr.do/wrdo:${TAG:-latest}
    container_name: wrdo
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/wrdo
      AUTH_SECRET: ${AUTH_SECRET:-your-auth-secret}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL}
      # 其他环境变量...
    depends_on:
      - postgres
    restart: unless-stopped

  postgres:
    image: postgres:16-alpine
    container_name: postgres
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=wrdo
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped

volumes:
  postgres-data:
    name: wrdo-postgres-data
```

#### 启动服务

```bash
# 创建 .env 文件并配置环境变量后
docker compose up -d

# 查看日志
docker compose logs -f app

# 停止服务
docker compose down
```

---

### 3.3 手动服务器部署

#### 步骤 1：安装依赖

```bash
# 安装 Node.js 20.x
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# 启用 Corepack 并安装 pnpm
corepack enable
corepack prepare pnpm@latest --activate

# 安装项目依赖
pnpm install --frozen-lockfile
```

#### 步骤 2：配置环境变量

```bash
cp .env.example .env
# 编辑 .env 文件
```

#### 步骤 3：初始化数据库

```bash
# 生成 Prisma 客户端
pnpm postinstall

# 运行数据库迁移
pnpm db:push
```

#### 步骤 4：构建并启动

```bash
# 构建生产版本
pnpm build

# 启动服务
pnpm start
```

或使用 PM2 管理进程：

```bash
# 安装 PM2
sudo npm install -g pm2

# 启动应用
pm2 start pnpm --name "wrdo" -- run start

# 设置开机自启
pm2 startup
pm2 save
```

---

## 4. 本地开发

```bash
# 安装依赖
pnpm install

# 初始化数据库
pnpm postinstall
pnpm db:push

# 启动开发服务器
pnpm dev
```

访问 http://localhost:3000

**默认账号**：
- 邮箱：`admin@admin.com`
- 密码：`123456`

---

## 5. 环境变量说明

### 核心变量

| 变量名 | 必填 | 说明 |
|--------|------|------|
| `NEXT_PUBLIC_APP_URL` | 是 | 应用访问地址 |
| `DATABASE_URL` | 是 | PostgreSQL 连接字符串 |
| `AUTH_SECRET` | 是 | NextAuth 密钥（32+字符） |
| `AUTH_URL` | 是 | NextAuth 回调地址 |

### 登录方式（可选）

| 变量名 | 说明 |
|--------|------|
| `GOOGLE_CLIENT_ID` | Google OAuth |
| `GOOGLE_CLIENT_SECRET` | Google OAuth Secret |
| `GITHUB_ID` | GitHub OAuth |
| `GITHUB_SECRET` | GitHub OAuth Secret |
| `LinuxDo_CLIENT_ID` | LinuxDO OAuth |
| `LinuxDo_CLIENT_SECRET` | LinuxDO OAuth Secret |

### 邮件服务（可选）

| 变量名 | 说明 |
|--------|------|
| `RESEND_API_KEY` | Resend 邮件 API Key |
| `BREVO_API_KEY` | Brevo 邮件 API Key |
| `EMAIL_FROM` | 发件人邮箱 |
| `EMAIL_FROM_NAME` | 发件人名称 |

### 其他配置

| 变量名 | 说明 |
|--------|------|
| `NEXT_PUBLIC_EMAIL_R2_DOMAIN` | Cloudflare R2 存储域名 |
| `NEXT_PUBLIC_GOOGLE_ID` | Google Analytics ID |
| `SCREENSHOTONE_BASE_URL` | 截图 API 地址 |
| `GITHUB_TOKEN` | GitHub API Token |
| `SKIP_DB_CHECK` | 跳过数据库检查（Docker） |
| `SKIP_DB_MIGRATION` | 跳过数据库迁移（Docker） |

---

## 6. 常见问题

### Q1：Docker 部署数据库连接失败

确保 `DATABASE_URL` 格式正确：
```
postgres://用户名:密码@主机地址:5432/数据库名
```

### Q2：端口冲突

修改 `docker-compose.yml` 中的端口映射：
```yaml
ports:
  - "8080:3000"  # 改为 8080
```

### Q3：数据库迁移失败

检查数据库权限和连接字符串，确保用户有 CREATE/ALTER 权限。

### Q4：环境变量修改后不生效

Docker 部署需要重新构建镜像：
```bash
docker compose down
docker compose up -d --build
```

---

## 7. 验证部署

部署成功后，访问应用并验证：

1. **首页**：确认页面正常加载
2. **登录**：使用默认管理员账号登录
3. **管理后台**：访问 `/admin` 确认功能正常
